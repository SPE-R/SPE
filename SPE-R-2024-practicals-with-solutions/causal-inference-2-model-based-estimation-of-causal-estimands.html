<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 14 Causal inference 2: Model-based estimation of causal estimands | Statistical Practice in Epidemiology with R</title>
  <meta name="description" content="This is the SPE-R 2024 exercises book" />
  <meta name="generator" content="bookdown 0.39 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 14 Causal inference 2: Model-based estimation of causal estimands | Statistical Practice in Epidemiology with R" />
  <meta property="og:type" content="book" />
  
  <meta property="og:description" content="This is the SPE-R 2024 exercises book" />
  <meta name="github-repo" content="spe-r/spe" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 14 Causal inference 2: Model-based estimation of causal estimands | Statistical Practice in Epidemiology with R" />
  
  <meta name="twitter:description" content="This is the SPE-R 2024 exercises book" />
  

<meta name="author" content="Krista Fischer" />
<meta name="author" content="Martyn Plummer" />
<meta name="author" content="Janne Pitkäniemi" />
<meta name="author" content="Bendix Carstensen" />
<meta name="author" content="Damien Georges" />
<meta name="author" content="Esa Läärä" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="nested-case-control-study-and-case-cohort-study-risk-factors-of-coronary-heart-disease.html"/>
<link rel="next" href="time-dependent-variables-and-multiple-states.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">SPE-R practicals</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>About</a></li>
<li class="chapter" data-level="1" data-path="practice-with-basic-r.html"><a href="practice-with-basic-r.html"><i class="fa fa-check"></i><b>1</b> Practice with basic R</a>
<ul>
<li class="chapter" data-level="1.1" data-path="practice-with-basic-r.html"><a href="practice-with-basic-r.html#the-working-directory"><i class="fa fa-check"></i><b>1.1</b> The working directory</a></li>
<li class="chapter" data-level="1.2" data-path="practice-with-basic-r.html"><a href="practice-with-basic-r.html#the-workspace"><i class="fa fa-check"></i><b>1.2</b> The workspace</a></li>
<li class="chapter" data-level="1.3" data-path="practice-with-basic-r.html"><a href="practice-with-basic-r.html#using-r-as-a-calculator"><i class="fa fa-check"></i><b>1.3</b> Using R as a calculator</a></li>
<li class="chapter" data-level="1.4" data-path="practice-with-basic-r.html"><a href="practice-with-basic-r.html#vectors"><i class="fa fa-check"></i><b>1.4</b> Vectors</a></li>
<li class="chapter" data-level="1.5" data-path="practice-with-basic-r.html"><a href="practice-with-basic-r.html#sequences"><i class="fa fa-check"></i><b>1.5</b> Sequences</a></li>
<li class="chapter" data-level="1.6" data-path="practice-with-basic-r.html"><a href="practice-with-basic-r.html#displaying-and-changing-parts-of-a-vector-indexing"><i class="fa fa-check"></i><b>1.6</b> Displaying and changing parts of a vector (indexing)</a></li>
<li class="chapter" data-level="1.7" data-path="practice-with-basic-r.html"><a href="practice-with-basic-r.html#lists"><i class="fa fa-check"></i><b>1.7</b> Lists</a></li>
<li class="chapter" data-level="1.8" data-path="practice-with-basic-r.html"><a href="practice-with-basic-r.html#data-frames"><i class="fa fa-check"></i><b>1.8</b> Data frames</a></li>
<li class="chapter" data-level="1.9" data-path="practice-with-basic-r.html"><a href="practice-with-basic-r.html#working-with-built-in-data-frames"><i class="fa fa-check"></i><b>1.9</b> Working with built-in data frames</a></li>
<li class="chapter" data-level="1.10" data-path="practice-with-basic-r.html"><a href="practice-with-basic-r.html#referencing-parts-of-the-data-frame-indexing"><i class="fa fa-check"></i><b>1.10</b> Referencing parts of the data frame (indexing)</a></li>
<li class="chapter" data-level="1.11" data-path="practice-with-basic-r.html"><a href="practice-with-basic-r.html#summaries"><i class="fa fa-check"></i><b>1.11</b> Summaries</a></li>
<li class="chapter" data-level="1.12" data-path="practice-with-basic-r.html"><a href="practice-with-basic-r.html#generating-new-variables"><i class="fa fa-check"></i><b>1.12</b> Generating new variables</a></li>
<li class="chapter" data-level="1.13" data-path="practice-with-basic-r.html"><a href="practice-with-basic-r.html#turning-a-variable-into-a-factor"><i class="fa fa-check"></i><b>1.13</b> Turning a variable into a factor</a></li>
<li class="chapter" data-level="1.14" data-path="practice-with-basic-r.html"><a href="practice-with-basic-r.html#frequency-tables"><i class="fa fa-check"></i><b>1.14</b> Frequency tables</a></li>
<li class="chapter" data-level="1.15" data-path="practice-with-basic-r.html"><a href="practice-with-basic-r.html#grouping-the-values-of-a-numeric-variable"><i class="fa fa-check"></i><b>1.15</b> Grouping the values of a numeric variable</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="reading-data-into-r.html"><a href="reading-data-into-r.html"><i class="fa fa-check"></i><b>2</b> Reading data into <code>R</code></a>
<ul>
<li class="chapter" data-level="2.1" data-path="reading-data-into-r.html"><a href="reading-data-into-r.html#introduction"><i class="fa fa-check"></i><b>2.1</b> Introduction</a></li>
<li class="chapter" data-level="2.2" data-path="reading-data-into-r.html"><a href="reading-data-into-r.html#data-sources"><i class="fa fa-check"></i><b>2.2</b> Data sources</a></li>
<li class="chapter" data-level="2.3" data-path="reading-data-into-r.html"><a href="reading-data-into-r.html#data-in-text-files"><i class="fa fa-check"></i><b>2.3</b> Data in text files</a></li>
<li class="chapter" data-level="2.4" data-path="reading-data-into-r.html"><a href="reading-data-into-r.html#things-that-can-go-wrong"><i class="fa fa-check"></i><b>2.4</b> Things that can go wrong</a></li>
<li class="chapter" data-level="2.5" data-path="reading-data-into-r.html"><a href="reading-data-into-r.html#forgetting-the-headers"><i class="fa fa-check"></i><b>2.5</b> Forgetting the headers</a></li>
<li class="chapter" data-level="2.6" data-path="reading-data-into-r.html"><a href="reading-data-into-r.html#using-the-wrong-separator"><i class="fa fa-check"></i><b>2.6</b> Using the wrong separator</a></li>
<li class="chapter" data-level="2.7" data-path="reading-data-into-r.html"><a href="reading-data-into-r.html#mis-specifying-the-representation-of-missing-values"><i class="fa fa-check"></i><b>2.7</b> Mis-specifying the representation of missing values</a></li>
<li class="chapter" data-level="2.8" data-path="reading-data-into-r.html"><a href="reading-data-into-r.html#spreadsheet-data"><i class="fa fa-check"></i><b>2.8</b> Spreadsheet data</a></li>
<li class="chapter" data-level="2.9" data-path="reading-data-into-r.html"><a href="reading-data-into-r.html#reading-data-from-the-internet"><i class="fa fa-check"></i><b>2.9</b> Reading data from the Internet</a></li>
<li class="chapter" data-level="2.10" data-path="reading-data-into-r.html"><a href="reading-data-into-r.html#reading-from-the-clipboard"><i class="fa fa-check"></i><b>2.10</b> Reading from the clipboard</a></li>
<li class="chapter" data-level="2.11" data-path="reading-data-into-r.html"><a href="reading-data-into-r.html#binary-data"><i class="fa fa-check"></i><b>2.11</b> Binary data</a></li>
<li class="chapter" data-level="2.12" data-path="reading-data-into-r.html"><a href="reading-data-into-r.html#summary"><i class="fa fa-check"></i><b>2.12</b> Summary</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="data-manipulation-with-tidyverse.html"><a href="data-manipulation-with-tidyverse.html"><i class="fa fa-check"></i><b>3</b> Data manipulation with <code>tidyverse</code></a>
<ul>
<li class="chapter" data-level="3.1" data-path="data-manipulation-with-tidyverse.html"><a href="data-manipulation-with-tidyverse.html#introduction-1"><i class="fa fa-check"></i><b>3.1</b> Introduction</a></li>
<li class="chapter" data-level="3.2" data-path="data-manipulation-with-tidyverse.html"><a href="data-manipulation-with-tidyverse.html#the-births-data"><i class="fa fa-check"></i><b>3.2</b> The <code>births</code> data</a></li>
<li class="chapter" data-level="3.3" data-path="data-manipulation-with-tidyverse.html"><a href="data-manipulation-with-tidyverse.html#tibble-vs-data.frame"><i class="fa fa-check"></i><b>3.3</b> <code>tibble</code> vs <code>data.frame</code></a></li>
<li class="chapter" data-level="3.4" data-path="data-manipulation-with-tidyverse.html"><a href="data-manipulation-with-tidyverse.html#piping-functions"><i class="fa fa-check"></i><b>3.4</b> Piping functions</a></li>
<li class="chapter" data-level="3.5" data-path="data-manipulation-with-tidyverse.html"><a href="data-manipulation-with-tidyverse.html#mutate-columns"><i class="fa fa-check"></i><b>3.5</b> <code>mutate</code> columns</a></li>
<li class="chapter" data-level="3.6" data-path="data-manipulation-with-tidyverse.html"><a href="data-manipulation-with-tidyverse.html#select-columns-filter-and-arrange-rows"><i class="fa fa-check"></i><b>3.6</b> <code>select</code> columns, <code>filter</code> and <code>arrange</code> rows</a></li>
<li class="chapter" data-level="3.7" data-path="data-manipulation-with-tidyverse.html"><a href="data-manipulation-with-tidyverse.html#group_by-and-summarise-data"><i class="fa fa-check"></i><b>3.7</b> <code>group_by</code> and <code>summarise</code> data</a></li>
<li class="chapter" data-level="3.8" data-path="data-manipulation-with-tidyverse.html"><a href="data-manipulation-with-tidyverse.html#multiple-grouping"><i class="fa fa-check"></i><b>3.8</b> Multiple grouping</a></li>
<li class="chapter" data-level="3.9" data-path="data-manipulation-with-tidyverse.html"><a href="data-manipulation-with-tidyverse.html#bind-and-join-tables"><i class="fa fa-check"></i><b>3.9</b> Bind and join tables</a></li>
<li class="chapter" data-level="3.10" data-path="data-manipulation-with-tidyverse.html"><a href="data-manipulation-with-tidyverse.html#data-visualization-with-ggplot2"><i class="fa fa-check"></i><b>3.10</b> Data Visualization with ggplot2</a></li>
<li class="chapter" data-level="3.11" data-path="data-manipulation-with-tidyverse.html"><a href="data-manipulation-with-tidyverse.html#pivoting-data-with-tidyr"><i class="fa fa-check"></i><b>3.11</b> pivoting data with tidyr</a></li>
<li class="chapter" data-level="3.12" data-path="data-manipulation-with-tidyverse.html"><a href="data-manipulation-with-tidyverse.html#reading-files-with-readr"><i class="fa fa-check"></i><b>3.12</b> reading files with readr</a></li>
<li class="chapter" data-level="3.13" data-path="data-manipulation-with-tidyverse.html"><a href="data-manipulation-with-tidyverse.html#string-manipulation-with-stringr"><i class="fa fa-check"></i><b>3.13</b> String manipulation with stringr</a></li>
<li class="chapter" data-level="3.14" data-path="data-manipulation-with-tidyverse.html"><a href="data-manipulation-with-tidyverse.html#purrr-package-to-apply-functions-to-list"><i class="fa fa-check"></i><b>3.14</b> purrr package to apply functions to list</a></li>
<li class="chapter" data-level="3.15" data-path="data-manipulation-with-tidyverse.html"><a href="data-manipulation-with-tidyverse.html#bonus-rendering-tables"><i class="fa fa-check"></i><b>3.15</b> Bonus: Rendering tables</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="tabulation.html"><a href="tabulation.html"><i class="fa fa-check"></i><b>4</b> Tabulation</a>
<ul>
<li class="chapter" data-level="4.1" data-path="tabulation.html"><a href="tabulation.html#introduction-2"><i class="fa fa-check"></i><b>4.1</b> Introduction</a></li>
<li class="chapter" data-level="4.2" data-path="tabulation.html"><a href="tabulation.html#the-births-data-1"><i class="fa fa-check"></i><b>4.2</b> The births data</a></li>
<li class="chapter" data-level="4.3" data-path="tabulation.html"><a href="tabulation.html#one-way-tables"><i class="fa fa-check"></i><b>4.3</b> One-way tables</a></li>
<li class="chapter" data-level="4.4" data-path="tabulation.html"><a href="tabulation.html#improving-the-presentation-of-tables"><i class="fa fa-check"></i><b>4.4</b> Improving the Presentation of Tables</a></li>
<li class="chapter" data-level="4.5" data-path="tabulation.html"><a href="tabulation.html#two-way-tables"><i class="fa fa-check"></i><b>4.5</b> Two-way Tables</a></li>
<li class="chapter" data-level="4.6" data-path="tabulation.html"><a href="tabulation.html#printing"><i class="fa fa-check"></i><b>4.6</b> Printing</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="graphics-in-r.html"><a href="graphics-in-r.html"><i class="fa fa-check"></i><b>5</b> Graphics in R</a>
<ul>
<li class="chapter" data-level="5.1" data-path="graphics-in-r.html"><a href="graphics-in-r.html#simple-plot-on-the-screen"><i class="fa fa-check"></i><b>5.1</b> Simple plot on the screen</a></li>
<li class="chapter" data-level="5.2" data-path="graphics-in-r.html"><a href="graphics-in-r.html#colours"><i class="fa fa-check"></i><b>5.2</b> Colours</a></li>
<li class="chapter" data-level="5.3" data-path="graphics-in-r.html"><a href="graphics-in-r.html#adding-to-a-plot"><i class="fa fa-check"></i><b>5.3</b> Adding to a plot</a></li>
<li class="chapter" data-level="5.4" data-path="graphics-in-r.html"><a href="graphics-in-r.html#using-indexing-for-plot-elements"><i class="fa fa-check"></i><b>5.4</b> Using indexing for plot elements</a></li>
<li class="chapter" data-level="5.5" data-path="graphics-in-r.html"><a href="graphics-in-r.html#generating-colours"><i class="fa fa-check"></i><b>5.5</b> Generating colours</a></li>
<li class="chapter" data-level="5.6" data-path="graphics-in-r.html"><a href="graphics-in-r.html#saving-your-graphs-for-use-in-other-documents"><i class="fa fa-check"></i><b>5.6</b> Saving your graphs for use in other documents</a></li>
<li class="chapter" data-level="5.7" data-path="graphics-in-r.html"><a href="graphics-in-r.html#interacting-with-a-plot"><i class="fa fa-check"></i><b>5.7</b> Interacting with a plot</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="analysis-of-hazard-rates-their-ratios-and-differences-and-binary-regression.html"><a href="analysis-of-hazard-rates-their-ratios-and-differences-and-binary-regression.html"><i class="fa fa-check"></i><b>6</b> Analysis of hazard rates, their ratios and differences and binary regression</a>
<ul>
<li class="chapter" data-level="6.1" data-path="analysis-of-hazard-rates-their-ratios-and-differences-and-binary-regression.html"><a href="analysis-of-hazard-rates-their-ratios-and-differences-and-binary-regression.html#hand-calculations-for-a-single-rate"><i class="fa fa-check"></i><b>6.1</b> Hand calculations for a single rate</a></li>
<li class="chapter" data-level="6.2" data-path="analysis-of-hazard-rates-their-ratios-and-differences-and-binary-regression.html"><a href="analysis-of-hazard-rates-their-ratios-and-differences-and-binary-regression.html#poisson-model-for-a-single-rate-with-logarithmic-link"><i class="fa fa-check"></i><b>6.2</b> Poisson model for a single rate with logarithmic link</a></li>
<li class="chapter" data-level="6.3" data-path="analysis-of-hazard-rates-their-ratios-and-differences-and-binary-regression.html"><a href="analysis-of-hazard-rates-their-ratios-and-differences-and-binary-regression.html#poisson-model-for-a-single-rate-with-identity-link"><i class="fa fa-check"></i><b>6.3</b> Poisson model for a single rate with identity link</a></li>
<li class="chapter" data-level="6.4" data-path="analysis-of-hazard-rates-their-ratios-and-differences-and-binary-regression.html"><a href="analysis-of-hazard-rates-their-ratios-and-differences-and-binary-regression.html#poisson-model-assuming-the-same-rate-for-several-periods"><i class="fa fa-check"></i><b>6.4</b> Poisson model assuming the same rate for several periods</a></li>
<li class="chapter" data-level="6.5" data-path="analysis-of-hazard-rates-their-ratios-and-differences-and-binary-regression.html"><a href="analysis-of-hazard-rates-their-ratios-and-differences-and-binary-regression.html#analysis-of-rate-ratio"><i class="fa fa-check"></i><b>6.5</b> Analysis of rate ratio</a></li>
<li class="chapter" data-level="6.6" data-path="analysis-of-hazard-rates-their-ratios-and-differences-and-binary-regression.html"><a href="analysis-of-hazard-rates-their-ratios-and-differences-and-binary-regression.html#analysis-of-rate-difference"><i class="fa fa-check"></i><b>6.6</b> Analysis of rate difference</a></li>
<li class="chapter" data-level="6.7" data-path="analysis-of-hazard-rates-their-ratios-and-differences-and-binary-regression.html"><a href="analysis-of-hazard-rates-their-ratios-and-differences-and-binary-regression.html#binary-regression"><i class="fa fa-check"></i><b>6.7</b> Binary regression</a></li>
<li class="chapter" data-level="6.8" data-path="analysis-of-hazard-rates-their-ratios-and-differences-and-binary-regression.html"><a href="analysis-of-hazard-rates-their-ratios-and-differences-and-binary-regression.html#optionalhomework-hand-calculations-and-calculations-using-matrix-tools"><i class="fa fa-check"></i><b>6.8</b> Optional/Homework: Hand calculations and calculations using matrix tools</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="estimation-of-effects-simple-and-more-complex.html"><a href="estimation-of-effects-simple-and-more-complex.html"><i class="fa fa-check"></i><b>7</b> Estimation of effects: simple and more complex</a>
<ul>
<li class="chapter" data-level="7.1" data-path="estimation-of-effects-simple-and-more-complex.html"><a href="estimation-of-effects-simple-and-more-complex.html#response-and-explanatory-variables"><i class="fa fa-check"></i><b>7.1</b> Response and explanatory variables</a></li>
<li class="chapter" data-level="7.2" data-path="estimation-of-effects-simple-and-more-complex.html"><a href="estimation-of-effects-simple-and-more-complex.html#data-set-births"><i class="fa fa-check"></i><b>7.2</b> Data set <code>births</code></a></li>
<li class="chapter" data-level="7.3" data-path="estimation-of-effects-simple-and-more-complex.html"><a href="estimation-of-effects-simple-and-more-complex.html#simple-estimation-with-lm-and-glm"><i class="fa fa-check"></i><b>7.3</b> Simple estimation with <code>lm()</code> and <code>glm()</code></a></li>
<li class="chapter" data-level="7.4" data-path="estimation-of-effects-simple-and-more-complex.html"><a href="estimation-of-effects-simple-and-more-complex.html#stratified-effects-and-interaction-or-effect-measure-modification"><i class="fa fa-check"></i><b>7.4</b> Stratified effects, and interaction or effect-measure modification</a></li>
<li class="chapter" data-level="7.5" data-path="estimation-of-effects-simple-and-more-complex.html"><a href="estimation-of-effects-simple-and-more-complex.html#controlling-or-adjusting-for-the-effect-of-hyp-for-sex"><i class="fa fa-check"></i><b>7.5</b> Controlling or adjusting for the effect of <code>hyp</code> for <code>sex</code></a></li>
<li class="chapter" data-level="7.6" data-path="estimation-of-effects-simple-and-more-complex.html"><a href="estimation-of-effects-simple-and-more-complex.html#numeric-exposure-simple-linear-regression-and-checking-assumptions"><i class="fa fa-check"></i><b>7.6</b> Numeric exposure, simple linear regression and checking assumptions</a></li>
<li class="chapter" data-level="7.7" data-path="estimation-of-effects-simple-and-more-complex.html"><a href="estimation-of-effects-simple-and-more-complex.html#penalized-spline-model"><i class="fa fa-check"></i><b>7.7</b> Penalized spline model</a></li>
<li class="chapter" data-level="7.8" data-path="estimation-of-effects-simple-and-more-complex.html"><a href="estimation-of-effects-simple-and-more-complex.html#analysis-of-binary-outcomes"><i class="fa fa-check"></i><b>7.8</b> Analysis of binary outcomes</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="poisson-regression-analysis-of-curved-effects.html"><a href="poisson-regression-analysis-of-curved-effects.html"><i class="fa fa-check"></i><b>8</b> Poisson regression &amp; analysis of curved effects</a>
<ul>
<li class="chapter" data-level="8.1" data-path="poisson-regression-analysis-of-curved-effects.html"><a href="poisson-regression-analysis-of-curved-effects.html#testis-cancer-data-input-and-housekeeping"><i class="fa fa-check"></i><b>8.1</b> Testis cancer: Data input and housekeeping</a></li>
<li class="chapter" data-level="8.2" data-path="poisson-regression-analysis-of-curved-effects.html"><a href="poisson-regression-analysis-of-curved-effects.html#some-descriptive-analysis"><i class="fa fa-check"></i><b>8.2</b> Some descriptive analysis</a></li>
<li class="chapter" data-level="8.3" data-path="poisson-regression-analysis-of-curved-effects.html"><a href="poisson-regression-analysis-of-curved-effects.html#age-and-period-as-categorical-factors"><i class="fa fa-check"></i><b>8.3</b> Age and period as categorical factors</a></li>
<li class="chapter" data-level="8.4" data-path="poisson-regression-analysis-of-curved-effects.html"><a href="poisson-regression-analysis-of-curved-effects.html#generalized-additive-model-with-penalized-splines"><i class="fa fa-check"></i><b>8.4</b> Generalized additive model with penalized splines</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="causal-inference.html"><a href="causal-inference.html"><i class="fa fa-check"></i><b>9</b> Causal inference</a>
<ul>
<li class="chapter" data-level="9.1" data-path="causal-inference.html"><a href="causal-inference.html#proper-adjustment-for-confounding-in-regression-models"><i class="fa fa-check"></i><b>9.1</b> Proper adjustment for confounding in regression models</a></li>
<li class="chapter" data-level="9.2" data-path="causal-inference.html"><a href="causal-inference.html#dag-tools-in-the-package-dagitty"><i class="fa fa-check"></i><b>9.2</b> DAG tools in the package <code>dagitty</code></a></li>
<li class="chapter" data-level="9.3" data-path="causal-inference.html"><a href="causal-inference.html#instrumental-variables-estimation-mendelian-randomization"><i class="fa fa-check"></i><b>9.3</b> Instrumental variables estimation: Mendelian randomization</a></li>
<li class="chapter" data-level="9.4" data-path="causal-inference.html"><a href="causal-inference.html#why-are-simulation-exercises-useful-for-causal-inference"><i class="fa fa-check"></i><b>9.4</b> Why are simulation exercises useful for causal inference?</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="graphics-with-ggplot2.html"><a href="graphics-with-ggplot2.html"><i class="fa fa-check"></i><b>10</b> Graphics with ggplot2</a>
<ul>
<li class="chapter" data-level="10.1" data-path="graphics-with-ggplot2.html"><a href="graphics-with-ggplot2.html#data"><i class="fa fa-check"></i><b>10.1</b> Data</a></li>
<li class="chapter" data-level="10.2" data-path="graphics-with-ggplot2.html"><a href="graphics-with-ggplot2.html#building-the-plot"><i class="fa fa-check"></i><b>10.2</b> Building the plot</a>
<ul>
<li class="chapter" data-level="10.2.1" data-path="graphics-with-ggplot2.html"><a href="graphics-with-ggplot2.html#the-ggplot2-package"><i class="fa fa-check"></i><b>10.2.1</b> The ggplot2 package</a></li>
<li class="chapter" data-level="10.2.2" data-path="graphics-with-ggplot2.html"><a href="graphics-with-ggplot2.html#geometries"><i class="fa fa-check"></i><b>10.2.2</b> Geometries</a></li>
<li class="chapter" data-level="10.2.3" data-path="graphics-with-ggplot2.html"><a href="graphics-with-ggplot2.html#scales"><i class="fa fa-check"></i><b>10.2.3</b> Scales</a></li>
<li class="chapter" data-level="10.2.4" data-path="graphics-with-ggplot2.html"><a href="graphics-with-ggplot2.html#themes"><i class="fa fa-check"></i><b>10.2.4</b> Themes</a></li>
<li class="chapter" data-level="10.2.5" data-path="graphics-with-ggplot2.html"><a href="graphics-with-ggplot2.html#putting-everything-together"><i class="fa fa-check"></i><b>10.2.5</b> Putting everything together</a></li>
</ul></li>
<li class="chapter" data-level="10.3" data-path="graphics-with-ggplot2.html"><a href="graphics-with-ggplot2.html#self-study"><i class="fa fa-check"></i><b>10.3</b> Self study</a></li>
<li class="chapter" data-level="10.4" data-path="graphics-with-ggplot2.html"><a href="graphics-with-ggplot2.html#adding-the-table-advanced-topic"><i class="fa fa-check"></i><b>10.4</b> Adding the table (advanced topic)</a></li>
<li class="chapter" data-level="10.5" data-path="graphics-with-ggplot2.html"><a href="graphics-with-ggplot2.html#references"><i class="fa fa-check"></i><b>10.5</b> References</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="survival-analysis-with-competing-risks-oral-cancer-patients.html"><a href="survival-analysis-with-competing-risks-oral-cancer-patients.html"><i class="fa fa-check"></i><b>11</b> Survival analysis with competing risks: Oral cancer patients</a>
<ul>
<li class="chapter" data-level="11.1" data-path="survival-analysis-with-competing-risks-oral-cancer-patients.html"><a href="survival-analysis-with-competing-risks-oral-cancer-patients.html#description-of-the-data"><i class="fa fa-check"></i><b>11.1</b> Description of the data</a></li>
<li class="chapter" data-level="11.2" data-path="survival-analysis-with-competing-risks-oral-cancer-patients.html"><a href="survival-analysis-with-competing-risks-oral-cancer-patients.html#loading-the-packages-and-the-data"><i class="fa fa-check"></i><b>11.2</b> Loading the packages and the data</a></li>
<li class="chapter" data-level="11.3" data-path="survival-analysis-with-competing-risks-oral-cancer-patients.html"><a href="survival-analysis-with-competing-risks-oral-cancer-patients.html#total-mortality-kaplanmeier-analyses"><i class="fa fa-check"></i><b>11.3</b> Total mortality: Kaplan–Meier analyses</a></li>
<li class="chapter" data-level="11.4" data-path="survival-analysis-with-competing-risks-oral-cancer-patients.html"><a href="survival-analysis-with-competing-risks-oral-cancer-patients.html#total-mortality-by-stage"><i class="fa fa-check"></i><b>11.4</b> Total mortality by stage</a></li>
<li class="chapter" data-level="11.5" data-path="survival-analysis-with-competing-risks-oral-cancer-patients.html"><a href="survival-analysis-with-competing-risks-oral-cancer-patients.html#event-specific-cumulative-mortality-curves"><i class="fa fa-check"></i><b>11.5</b> Event-specific cumulative mortality curves</a></li>
<li class="chapter" data-level="11.6" data-path="survival-analysis-with-competing-risks-oral-cancer-patients.html"><a href="survival-analysis-with-competing-risks-oral-cancer-patients.html#regression-modelling-of-overall-mortality."><i class="fa fa-check"></i><b>11.6</b> Regression modelling of overall mortality.</a></li>
<li class="chapter" data-level="11.7" data-path="survival-analysis-with-competing-risks-oral-cancer-patients.html"><a href="survival-analysis-with-competing-risks-oral-cancer-patients.html#modelling-event-specific-hazards"><i class="fa fa-check"></i><b>11.7</b> Modelling event-specific hazards</a></li>
<li class="chapter" data-level="11.8" data-path="survival-analysis-with-competing-risks-oral-cancer-patients.html"><a href="survival-analysis-with-competing-risks-oral-cancer-patients.html#lexis-object-with-multi-state-set-up"><i class="fa fa-check"></i><b>11.8</b> Lexis object with multi-state set-up</a></li>
<li class="chapter" data-level="11.9" data-path="survival-analysis-with-competing-risks-oral-cancer-patients.html"><a href="survival-analysis-with-competing-risks-oral-cancer-patients.html#optional-poisson-regression-as-an-alternative-to-cox-model"><i class="fa fa-check"></i><b>11.9</b> Optional: Poisson regression as an alternative to Cox model</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="time-splitting-time-scales-and-smr.html"><a href="time-splitting-time-scales-and-smr.html"><i class="fa fa-check"></i><b>12</b> Time-splitting, time-scales and SMR</a>
<ul>
<li class="chapter" data-level="12.1" data-path="time-splitting-time-scales-and-smr.html"><a href="time-splitting-time-scales-and-smr.html#age-specific-mortality"><i class="fa fa-check"></i><b>12.1</b> Age-specific mortality</a></li>
<li class="chapter" data-level="12.2" data-path="time-splitting-time-scales-and-smr.html"><a href="time-splitting-time-scales-and-smr.html#smr"><i class="fa fa-check"></i><b>12.2</b> SMR</a></li>
<li class="chapter" data-level="12.3" data-path="time-splitting-time-scales-and-smr.html"><a href="time-splitting-time-scales-and-smr.html#smr-modeling"><i class="fa fa-check"></i><b>12.3</b> SMR modeling</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="nested-case-control-study-and-case-cohort-study-risk-factors-of-coronary-heart-disease.html"><a href="nested-case-control-study-and-case-cohort-study-risk-factors-of-coronary-heart-disease.html"><i class="fa fa-check"></i><b>13</b> Nested case-control study and case-cohort study: Risk factors of coronary heart disease</a>
<ul>
<li class="chapter" data-level="13.1" data-path="nested-case-control-study-and-case-cohort-study-risk-factors-of-coronary-heart-disease.html"><a href="nested-case-control-study-and-case-cohort-study-risk-factors-of-coronary-heart-disease.html#reading-the-cohort-data-illustrating-the-study-base-and-risk-sets"><i class="fa fa-check"></i><b>13.1</b> Reading the cohort data, illustrating the study base and risk sets</a></li>
<li class="chapter" data-level="13.2" data-path="nested-case-control-study-and-case-cohort-study-risk-factors-of-coronary-heart-disease.html"><a href="nested-case-control-study-and-case-cohort-study-risk-factors-of-coronary-heart-disease.html#nested-case-control-study"><i class="fa fa-check"></i><b>13.2</b> Nested case-control study</a></li>
<li class="chapter" data-level="13.3" data-path="nested-case-control-study-and-case-cohort-study-risk-factors-of-coronary-heart-disease.html"><a href="nested-case-control-study-and-case-cohort-study-risk-factors-of-coronary-heart-disease.html#case-cohort-study"><i class="fa fa-check"></i><b>13.3</b> Case-cohort study</a></li>
<li class="chapter" data-level="13.4" data-path="nested-case-control-study-and-case-cohort-study-risk-factors-of-coronary-heart-disease.html"><a href="nested-case-control-study-and-case-cohort-study-risk-factors-of-coronary-heart-disease.html#do-these-estimates-resemble-those-obtained-from-nested-case-control-data"><i class="fa fa-check"></i><b>13.4</b> Do these estimates resemble those obtained from nested case-control data?</a></li>
<li class="chapter" data-level="13.5" data-path="nested-case-control-study-and-case-cohort-study-risk-factors-of-coronary-heart-disease.html"><a href="nested-case-control-study-and-case-cohort-study-risk-factors-of-coronary-heart-disease.html#full-cohort-analysis-and-comparisons"><i class="fa fa-check"></i><b>13.5</b> Full cohort analysis and comparisons</a></li>
<li class="chapter" data-level="13.6" data-path="nested-case-control-study-and-case-cohort-study-risk-factors-of-coronary-heart-disease.html"><a href="nested-case-control-study-and-case-cohort-study-risk-factors-of-coronary-heart-disease.html#further-exercises-and-homework"><i class="fa fa-check"></i><b>13.6</b> Further exercises and homework</a></li>
</ul></li>
<li class="chapter" data-level="14" data-path="causal-inference-2-model-based-estimation-of-causal-estimands.html"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html"><i class="fa fa-check"></i><b>14</b> Causal inference 2: Model-based estimation of causal estimands</a>
<ul>
<li class="chapter" data-level="14.1" data-path="causal-inference-2-model-based-estimation-of-causal-estimands.html"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#control-of-confounding"><i class="fa fa-check"></i><b>14.1</b> Control of confounding</a></li>
<li class="chapter" data-level="14.2" data-path="causal-inference-2-model-based-estimation-of-causal-estimands.html"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#generation-of-target-population-and-true-models"><i class="fa fa-check"></i><b>14.2</b> Generation of target population and true models</a></li>
<li class="chapter" data-level="14.3" data-path="causal-inference-2-model-based-estimation-of-causal-estimands.html"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#factual-and-counterfactual-risks---associational-and-causal-contrasts"><i class="fa fa-check"></i><b>14.3</b> Factual and counterfactual risks - associational and causal contrasts</a></li>
<li class="chapter" data-level="14.4" data-path="causal-inference-2-model-based-estimation-of-causal-estimands.html"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#outcome-modelling-and-estimation-of-causal-contrasts-by-g-formula"><i class="fa fa-check"></i><b>14.4</b> Outcome modelling and estimation of causal contrasts by g-formula</a></li>
<li class="chapter" data-level="14.5" data-path="causal-inference-2-model-based-estimation-of-causal-estimands.html"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#inverse-probability-weighting-ipw-by"><i class="fa fa-check"></i><b>14.5</b> Inverse probability weighting (IPW) by</a></li>
<li class="chapter" data-level="14.6" data-path="causal-inference-2-model-based-estimation-of-causal-estimands.html"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#improving-ipw-estimation-and-using-r-package-psweight"><i class="fa fa-check"></i><b>14.6</b> Improving IPW estimation and using R package <code>PSweight</code></a></li>
<li class="chapter" data-level="14.7" data-path="causal-inference-2-model-based-estimation-of-causal-estimands.html"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#targeted-maximum-likelihood-estimation-tmle"><i class="fa fa-check"></i><b>14.7</b> Targeted maximum likelihood estimation (TMLE)</a></li>
<li class="chapter" data-level="14.8" data-path="causal-inference-2-model-based-estimation-of-causal-estimands.html"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#tmle-with-superlearner"><i class="fa fa-check"></i><b>14.8</b> TMLE with SuperLearner</a></li>
</ul></li>
<li class="chapter" data-level="15" data-path="time-dependent-variables-and-multiple-states.html"><a href="time-dependent-variables-and-multiple-states.html"><i class="fa fa-check"></i><b>15</b> Time-dependent variables and multiple states</a>
<ul>
<li class="chapter" data-level="15.1" data-path="time-dependent-variables-and-multiple-states.html"><a href="time-dependent-variables-and-multiple-states.html#the-renal-failure-dataset"><i class="fa fa-check"></i><b>15.1</b> The renal failure dataset</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/SPE-R/SPE" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Statistical Practice in Epidemiology with R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="causal-inference-2-model-based-estimation-of-causal-estimands" class="section level1 hasAnchor" number="14">
<h1><span class="header-section-number">Chapter 14</span> Causal inference 2: Model-based estimation of causal estimands<a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#causal-inference-2-model-based-estimation-of-causal-estimands" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>Sources of inspiration: <a href="https://doi.org/10.1002/sim.7628">Luque Fernandez, M.A. et al.
(2018)</a> <em>Stat Med</em>
2018;37(16):2530-2546 and<br />
<a href="https://doi.org/10.1002/sim.9234">Smith et al. (2022)</a> <em>Stat Med</em>
2022;41(2):407-432.</p>
<p>We shall illustrate with simulated data the estimation of causal effects
of a binary exposure <span class="math inline">\(X\)</span> when the outcome <span class="math inline">\(Y\)</span> is also binary, and there
is a set of four covariates <span class="math inline">\(Z = (Z_1, Z_2, Z_3, Z_4)\)</span>. As a background
story, we imagine a population of cancer patients, in whom the variables
and the assumed marginal distributions of the covariates are</p>
<table>
<colgroup>
<col width="21%" />
<col width="78%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">Variable</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left"><span class="math inline">\(X\)</span></td>
<td align="left">treatment; 1: radiotherapy only, 0: radiotherapy + chemotherapy</td>
</tr>
<tr class="even">
<td align="left"><span class="math inline">\(Y\)</span></td>
<td align="left">death during one year after diagnosis of cancer</td>
</tr>
<tr class="odd">
<td align="left"><span class="math inline">\(Z_1\)</span></td>
<td align="left">sex; 0: man, 1: woman; <span class="math inline">\(Z_1 \sim \text{Bern}(0.5)\)</span></td>
</tr>
<tr class="even">
<td align="left"><span class="math inline">\(Z_2\)</span></td>
<td align="left">age group 0; <code>young</code>, 1: <code>old</code>; <span class="math inline">\(Z_2 \sim \text{Bern}(0.65)\)</span></td>
</tr>
<tr class="odd">
<td align="left"><span class="math inline">\(Z_3\)</span></td>
<td align="left">stage of cancer; 4 classes; <span class="math inline">\(Z_3 \sim \text{DiscUnif}(1, \dots, 4)\)</span></td>
</tr>
<tr class="even">
<td align="left"><span class="math inline">\(Z_4\)</span></td>
<td align="left">comorbidity score; 5 classes; <span class="math inline">\(Z_3 \sim \text{DiscUnif}(1, \dots, 5)\)</span></td>
</tr>
</tbody>
</table>
<p>For simplicity, covariates <span class="math inline">\(Z_3\)</span> and <span class="math inline">\(Z_4\)</span> are treated as continuous
variables in the models. The assumed causal diagram is shown below.</p>
<p><img src="causInf2-s_files/figure-html/unnamed-chunk-2-1.png" width="672" /></p>
<p>For more generic notation, the probabilities of <span class="math inline">\(Y=1\)</span> will be expressed
as expectations, e.g. <span class="math inline">\(E(Y^{X=x}) = P(Y^{X=x}=1)\)</span> and
<span class="math inline">\(E(Y|X=x, Z=z) = P(Y=1|X=x, Z=z)\)</span>, where <span class="math inline">\(Z\)</span> is the vector of relevant
covariates. The same principle is applied in expressing the conditional
probability of <span class="math inline">\(X=1\)</span> given <span class="math inline">\(Z=z\)</span>. The fitted or predicted probabilities
of <span class="math inline">\(Y=1\)</span> are denoted as fitted <span class="math inline">\(\widehat{Y}\)</span> or predicted values
<span class="math inline">\(\widetilde{Y}\)</span> of <span class="math inline">\(Y\)</span> with pertinent subscripts and/or superscripts.
Both <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span> are modelled by logistic regression. The expit-function
or inverse of the logit function is defined:
<span class="math inline">\(\text{expit}(u) = 1/(1 + e^{-u})\)</span>, <span class="math inline">\(u\in R\)</span>. This is equal to the
cumulative distribution function of the standard logistic distribution,
the values of which are returned in R by <code>plogis(u)</code>. The R function
that returns values of the logit-function is <code>qlogis()</code>.</p>
<p>The true model assumed for the dependence of exposure <span class="math inline">\(X\)</span> on covariates:
<span class="math display">\[ E(X|Z_1 = z_1, \dots, Z_4 = z_4) =
      \text{expit}(-5 + 0.05z_2 + 0.25z_3 + 0.5z_4 + 0.4z_2z_4) . \]</span> The
assumed true model for the outcome is
<span class="math display">\[ E(Y|X=x, Z_1 = z_1, \dots, Z_4 = z_4) =
           \text{expit}(-1 + x - 0.1z_1 + 0.35z_2 + 0.25z_3 +
                 0.20z_4 + 0.15z_2z_4) \]</span> Note that <span class="math inline">\(X\)</span> does not depend
on <span class="math inline">\(Z_1\)</span>, and that in both models there is a product term <span class="math inline">\(Z_2 Z_4\)</span>,
which appears weaker for the outcome model.</p>
<div id="control-of-confounding" class="section level2 hasAnchor" number="14.1">
<h2><span class="header-section-number">14.1</span> Control of confounding<a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#control-of-confounding" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ol style="list-style-type: decimal">
<li><p>Based on inspection of the causal diagram, can you provide
justification for the claim that variables <span class="math inline">\(Z_2, Z_3\)</span> and <span class="math inline">\(Z_4\)</span> form
a proper subset of the four covariates, which is sufficient to block
all backdoor paths between <span class="math inline">\(X\)</span> and <span class="math inline">\(Y\)</span> and thus remove confounding?</p></li>
<li><p>Even though we have such a minimal sufficient set as indicated in
item (a), why could it still be worth while to include covariate
<span class="math inline">\(Z_1\)</span>, too, when modelling the outcome?</p></li>
</ol>
</div>
<div id="generation-of-target-population-and-true-models" class="section level2 hasAnchor" number="14.2">
<h2><span class="header-section-number">14.2</span> Generation of target population and true models<a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#generation-of-target-population-and-true-models" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ol style="list-style-type: decimal">
<li>Load the necessary packages.</li>
</ol>
<div class="sourceCode" id="cb649"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb649-1"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb649-1" tabindex="-1"></a><span class="fu">library</span>(Epi)</span>
<span id="cb649-2"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb649-2" tabindex="-1"></a><span class="fu">library</span>(stdReg)</span>
<span id="cb649-3"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb649-3" tabindex="-1"></a><span class="fu">library</span>(PSweight)</span>
<span id="cb649-4"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb649-4" tabindex="-1"></a><span class="fu">library</span>(SuperLearner)</span></code></pre></div>
<pre><code>## Loading required package: nnls</code></pre>
<pre><code>## Loading required package: gam</code></pre>
<pre><code>## Loading required package: splines</code></pre>
<pre><code>## Loading required package: foreach</code></pre>
<pre><code>## Loaded gam 1.22-3</code></pre>
<pre><code>## Super Learner</code></pre>
<pre><code>## Version: 2.0-29</code></pre>
<pre><code>## Package created on 2024-02-06</code></pre>
<div class="sourceCode" id="cb658"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb658-1"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb658-1" tabindex="-1"></a><span class="fu">library</span>(tmle)</span></code></pre></div>
<pre><code>## Loading required package: glmnet</code></pre>
<pre><code>## Loading required package: Matrix</code></pre>
<pre><code>## Loaded glmnet 4.1-8</code></pre>
<pre><code>## Welcome to the tmle package, version 2.0.1
## 
## Use tmleNews() to see details on changes and bug fixes</code></pre>
<ol start="2" style="list-style-type: decimal">
<li>Define the R-functions which computes expected values for the
exposure and outcome based on the assumed true outcome model and the
true exposure model.</li>
</ol>
<div class="sourceCode" id="cb663"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb663-1"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb663-1" tabindex="-1"></a>EX <span class="ot">&lt;-</span> <span class="cf">function</span>(z2, z3, z4) {</span>
<span id="cb663-2"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb663-2" tabindex="-1"></a>  <span class="fu">plogis</span>(<span class="sc">-</span><span class="dv">5</span> <span class="sc">+</span> <span class="fl">0.05</span> <span class="sc">*</span> z2 <span class="sc">+</span> <span class="fl">0.25</span> <span class="sc">*</span> z3 <span class="sc">+</span> <span class="fl">0.5</span> <span class="sc">*</span> z4 <span class="sc">+</span> <span class="fl">0.4</span> <span class="sc">*</span> z2 <span class="sc">*</span> z4)</span>
<span id="cb663-3"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb663-3" tabindex="-1"></a>}</span>
<span id="cb663-4"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb663-4" tabindex="-1"></a>EY <span class="ot">&lt;-</span> <span class="cf">function</span>(x, z1, z2, z3, z4) {</span>
<span id="cb663-5"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb663-5" tabindex="-1"></a>  <span class="fu">plogis</span>(<span class="sc">-</span><span class="dv">1</span> <span class="sc">+</span> x <span class="sc">-</span> <span class="fl">0.1</span> <span class="sc">*</span> z1 <span class="sc">+</span> <span class="fl">0.35</span> <span class="sc">*</span> z2 <span class="sc">+</span> <span class="fl">0.25</span> <span class="sc">*</span> z3 <span class="sc">+</span></span>
<span id="cb663-6"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb663-6" tabindex="-1"></a>    <span class="fl">0.20</span> <span class="sc">*</span> z4 <span class="sc">+</span> <span class="fl">0.15</span> <span class="sc">*</span> z2 <span class="sc">*</span> z4)</span>
<span id="cb663-7"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb663-7" tabindex="-1"></a>}</span></code></pre></div>
<ol start="3" style="list-style-type: decimal">
<li>Define the function for the generation of data by simulating random
values from pertinent probability distributions based on the given
assumptions.</li>
</ol>
<div class="sourceCode" id="cb664"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb664-1"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb664-1" tabindex="-1"></a>genData <span class="ot">&lt;-</span> <span class="cf">function</span>(N) {</span>
<span id="cb664-2"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb664-2" tabindex="-1"></a>  z1 <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(N, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> <span class="fl">0.5</span>) <span class="co"># Bern(0.5)</span></span>
<span id="cb664-3"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb664-3" tabindex="-1"></a>  z2 <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(N, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> <span class="fl">0.65</span>) <span class="co"># Bern(0.65)</span></span>
<span id="cb664-4"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb664-4" tabindex="-1"></a>  z3 <span class="ot">&lt;-</span> <span class="fu">trunc</span>(<span class="fu">runif</span>(N, <span class="at">min =</span> <span class="dv">1</span>, <span class="at">max =</span> <span class="dv">5</span>), <span class="at">digits =</span> <span class="dv">0</span>) <span class="co"># DiscUnif(1,4)</span></span>
<span id="cb664-5"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb664-5" tabindex="-1"></a>  z4 <span class="ot">&lt;-</span> <span class="fu">trunc</span>(<span class="fu">runif</span>(N, <span class="at">min =</span> <span class="dv">1</span>, <span class="at">max =</span> <span class="dv">6</span>), <span class="at">digits =</span> <span class="dv">0</span>) <span class="co"># DiscUnif(1,5)</span></span>
<span id="cb664-6"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb664-6" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(N, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> <span class="fu">EX</span>(z2, z3, z4))</span>
<span id="cb664-7"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb664-7" tabindex="-1"></a>  y <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(N, <span class="at">size =</span> <span class="dv">1</span>, <span class="at">prob =</span> <span class="fu">EY</span>(x, z1, z2, z3, z4))</span>
<span id="cb664-8"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb664-8" tabindex="-1"></a>  <span class="fu">data.frame</span>(z1, z2, z3, z4, x, y)</span>
<span id="cb664-9"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb664-9" tabindex="-1"></a>}</span></code></pre></div>
<ol start="4" style="list-style-type: decimal">
<li>Generate a data frame <code>dd</code> for a big target population of 500000
subjects</li>
</ol>
<div class="sourceCode" id="cb665"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb665-1"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb665-1" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">500000</span></span>
<span id="cb665-2"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb665-2" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">7777</span>)</span>
<span id="cb665-3"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb665-3" tabindex="-1"></a>dd <span class="ot">&lt;-</span> <span class="fu">genData</span>(N)</span></code></pre></div>
</div>
<div id="factual-and-counterfactual-risks---associational-and-causal-contrasts" class="section level2 hasAnchor" number="14.3">
<h2><span class="header-section-number">14.3</span> Factual and counterfactual risks - associational and causal contrasts<a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#factual-and-counterfactual-risks---associational-and-causal-contrasts" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ol style="list-style-type: decimal">
<li>Compute the factual risks of death for the two exposure groups
<span class="math display">\[ E(Y|X=x) = P(Y=1|X=x) = \frac{P(Y=1\ \&amp;\ X=x)}{P(X=x)},
\quad x=0,1, \]</span> in the whole target population, as well as their
associational contrasts: risk difference, risk ratio, and odds
ratio. Before that define a useful function</li>
</ol>
<div class="sourceCode" id="cb666"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb666-1"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb666-1" tabindex="-1"></a>Contr <span class="ot">&lt;-</span> <span class="cf">function</span>(mu1, mu0) {</span>
<span id="cb666-2"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb666-2" tabindex="-1"></a>  RD <span class="ot">&lt;-</span> mu1 <span class="sc">-</span> mu0</span>
<span id="cb666-3"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb666-3" tabindex="-1"></a>  RR <span class="ot">&lt;-</span> mu1 <span class="sc">/</span> mu0</span>
<span id="cb666-4"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb666-4" tabindex="-1"></a>  OR <span class="ot">&lt;-</span> (mu1 <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> mu1)) <span class="sc">/</span> (mu0 <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> mu0))</span>
<span id="cb666-5"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb666-5" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">c</span>(mu1, mu0, <span class="at">RD =</span> RD, <span class="at">RR =</span> RR, <span class="at">OR =</span> OR))</span>
<span id="cb666-6"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb666-6" tabindex="-1"></a>}</span>
<span id="cb666-7"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb666-7" tabindex="-1"></a>Ey1 <span class="ot">&lt;-</span> <span class="fu">with</span>(dd, <span class="fu">sum</span>(y <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> x <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">/</span> <span class="fu">sum</span>(x <span class="sc">==</span> <span class="dv">1</span>))</span>
<span id="cb666-8"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb666-8" tabindex="-1"></a>Ey0 <span class="ot">&lt;-</span> <span class="fu">with</span>(dd, <span class="fu">sum</span>(y <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> x <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">/</span> <span class="fu">sum</span>(x <span class="sc">==</span> <span class="dv">0</span>))</span>
<span id="cb666-9"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb666-9" tabindex="-1"></a><span class="fu">round</span>(<span class="fu">Contr</span>(Ey1, Ey0), <span class="dv">4</span>)</span></code></pre></div>
<pre><code>##                   RD     RR     OR 
## 0.8949 0.6288 0.2661 1.4232 5.0286</code></pre>
<p>How much bigger is the risk of death of those factually exposed to
radiotherapy only as compared with those receiving chemotherapy, too?</p>
<ol start="2" style="list-style-type: decimal">
<li>Compute now first the counterfactual risks of death
<span class="math inline">\(E(Y_i^{X_i=x}) = P(Y_i^{X_i=x}=1) = \pi_i^{X_i=x}\)</span> for each
individual under the alternative treatments or exposure values
<span class="math inline">\(x=0,1\)</span> with given covariate values, then the average or overall
counterfactual risks <span class="math inline">\(E(Y^{X=1}) = \pi^1\)</span> and <span class="math inline">\(E(Y^{X=0}) = \pi^0\)</span>
in the population, and finally the true marginal causal contrasts
for the effect of <span class="math inline">\(X\)</span>: <span class="math display">\[
\begin{aligned}
\text{RD} &amp; = E(Y^{X=1})-E(Y^{X=0}), \qquad  \text{RR} = E(Y^{X=1})/E(Y^{X=0}), \\
\text{OR} &amp; = \frac{E(Y^{X=1})/[1 -  E(Y^{X=1})]}{E(Y^{X=0})/[1 -  E(Y^{X=0})] }
\end{aligned}
\]</span></li>
</ol>
<div class="sourceCode" id="cb668"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb668-1"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb668-1" tabindex="-1"></a>dd <span class="ot">&lt;-</span> <span class="fu">transform</span>(dd,</span>
<span id="cb668-2"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb668-2" tabindex="-1"></a>  <span class="at">EY1.ind =</span> <span class="fu">EY</span>(<span class="at">x =</span> <span class="dv">1</span>, z1, z2, z3, z4),</span>
<span id="cb668-3"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb668-3" tabindex="-1"></a>  <span class="at">EY0.ind =</span> <span class="fu">EY</span>(<span class="at">x =</span> <span class="dv">0</span>, z1, z2, z3, z4)</span>
<span id="cb668-4"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb668-4" tabindex="-1"></a>)</span>
<span id="cb668-5"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb668-5" tabindex="-1"></a>EY1 <span class="ot">&lt;-</span> <span class="fu">mean</span>(dd<span class="sc">$</span>EY1.ind)</span>
<span id="cb668-6"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb668-6" tabindex="-1"></a>EY0 <span class="ot">&lt;-</span> <span class="fu">mean</span>(dd<span class="sc">$</span>EY0.ind)</span>
<span id="cb668-7"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb668-7" tabindex="-1"></a><span class="fu">round</span>(<span class="fu">Contr</span>(EY1, EY0), <span class="dv">4</span>)</span></code></pre></div>
<pre><code>##                   RD     RR     OR 
## 0.8273 0.6530 0.1743 1.2670 2.5462</code></pre>
<ol start="3" style="list-style-type: decimal">
<li>Compare the associational contrasts computed in in item (a) with the
causal contrasts in item (b). What do you conclude about
confoundedness of the associational contrasts?</li>
</ol>
</div>
<div id="outcome-modelling-and-estimation-of-causal-contrasts-by-g-formula" class="section level2 hasAnchor" number="14.4">
<h2><span class="header-section-number">14.4</span> Outcome modelling and estimation of causal contrasts by g-formula<a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#outcome-modelling-and-estimation-of-causal-contrasts-by-g-formula" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>As the first approach for estimating causal contrasts of interest we
apply the method of standardization or g-formula. It is based on a
hopefully realistic enough model for <span class="math inline">\(E(Y|X=x, Z=z)\)</span>, i.e. how the risk
of outcome is expected to depend on the exposure variable <span class="math inline">\(X\)</span> and on a
sufficient set <span class="math inline">\(Z\)</span> of confounders. The counterfactual risks
<span class="math inline">\(E(Y^{X=x}), x=0,1\)</span>, are marginal expectations of the above quantities,
standardized over the joint distribution of the confounders <span class="math inline">\(Z\)</span> in the
target population. <span class="math display">\[ E(Y^{X=x}) = E_Z[E(Y|X=x,Z)]
       = \int E(Y|X=x, Z=z)dF_Z(z), \quad x=0,1. \]</span></p>
<ol style="list-style-type: decimal">
<li>Assume now a <em>slightly misspecified</em> model <code>mY</code> for the outcome,
which contains only main effect terms of the explanatory variables:
<span class="math display">\[ \pi_i = E(Y_i|X_i=x_i, Z_{i1}=z_{i1}, \dots, Z_{i4}=z_{i4}) =
  \text{expit}\left(\beta_0 + \delta x_i +
  \sum_{j=1}^4 \beta_j z_{ij} \right) \]</span> Fit this model on the
target population using function <code>glm()</code>
<!-- % in order to have an accurate -->
<!-- % estimate of the possible bias due to misspecification of the outcome -->
<!-- % model --></li>
</ol>
<div class="sourceCode" id="cb670"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb670-1"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb670-1" tabindex="-1"></a>mY <span class="ot">&lt;-</span> <span class="fu">glm</span>(y <span class="sc">~</span> x <span class="sc">+</span> z1 <span class="sc">+</span> z2 <span class="sc">+</span> z3 <span class="sc">+</span> z4, <span class="at">family =</span> binomial, <span class="at">data =</span> dd)</span>
<span id="cb670-2"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb670-2" tabindex="-1"></a><span class="fu">round</span>(<span class="fu">ci.lin</span>(mY, <span class="at">Exp =</span> <span class="cn">TRUE</span>)[, <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">5</span>)], <span class="dv">3</span>)</span></code></pre></div>
<pre><code>##             Estimate exp(Est.)
## (Intercept)   -1.240     0.289
## x              1.052     2.863
## z1            -0.095     0.909
## z2             0.767     2.153
## z3             0.250     1.284
## z4             0.279     1.322</code></pre>
<p>There is not much idea in looking at the standard errors or confidence
intervals in such a big population.</p>
<ol start="2" style="list-style-type: decimal">
<li>For each subject <span class="math inline">\(i\)</span>, compute the fitted individual risk
<span class="math inline">\(\widehat{Y_i}\)</span> as well as the predicted counterfactual risks
<span class="math inline">\(\widetilde{Y_i}^{X_i=x}\)</span> for both exposure levels <span class="math inline">\(x=0,1\)</span>
separately, keeping the individual values of the <span class="math inline">\(Z\)</span>-variables as
they are.</li>
</ol>
<div class="sourceCode" id="cb672"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb672-1"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb672-1" tabindex="-1"></a>dd<span class="sc">$</span>yh <span class="ot">&lt;-</span> <span class="fu">predict</span>(mY, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>) <span class="co">#  fitted values</span></span>
<span id="cb672-2"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb672-2" tabindex="-1"></a>dd<span class="sc">$</span>yp1 <span class="ot">&lt;-</span> <span class="fu">predict</span>(mY, <span class="at">newdata =</span> <span class="fu">data.frame</span>(</span>
<span id="cb672-3"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb672-3" tabindex="-1"></a>  <span class="at">x =</span> <span class="fu">rep</span>(<span class="dv">1</span>, N), <span class="co"># x=1</span></span>
<span id="cb672-4"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb672-4" tabindex="-1"></a>  dd[, <span class="fu">c</span>(<span class="st">&quot;z1&quot;</span>, <span class="st">&quot;z2&quot;</span>, <span class="st">&quot;z3&quot;</span>, <span class="st">&quot;z4&quot;</span>)]</span>
<span id="cb672-5"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb672-5" tabindex="-1"></a>), <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb672-6"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb672-6" tabindex="-1"></a>dd<span class="sc">$</span>yp0 <span class="ot">&lt;-</span> <span class="fu">predict</span>(mY, <span class="at">newdata =</span> <span class="fu">data.frame</span>(</span>
<span id="cb672-7"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb672-7" tabindex="-1"></a>  <span class="at">x =</span> <span class="fu">rep</span>(<span class="dv">0</span>, N), <span class="co"># x=0</span></span>
<span id="cb672-8"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb672-8" tabindex="-1"></a>  dd[, <span class="fu">c</span>(<span class="st">&quot;z1&quot;</span>, <span class="st">&quot;z2&quot;</span>, <span class="st">&quot;z3&quot;</span>, <span class="st">&quot;z4&quot;</span>)]</span>
<span id="cb672-9"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb672-9" tabindex="-1"></a>), <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span></code></pre></div>
<ol start="3" style="list-style-type: decimal">
<li>Applying the method of standardization or g-formula compute now the
point estimates <span class="math display">\[ \widehat{E}_g(Y^{X=x}) =
\frac{1}{n} \sum_{i=1}^n \widetilde{Y}_i^{X_i=x}, \quad x=0,1. \]</span>
of the two counterfactual risks <span class="math inline">\(E(Y^{X=1}) = \pi^1\)</span> and
<span class="math inline">\(E(Y^{X=0})=\pi^0\)</span> as well as the marginal causal contrasts</li>
</ol>
<div class="sourceCode" id="cb673"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb673-1"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb673-1" tabindex="-1"></a>EY1.g <span class="ot">&lt;-</span> <span class="fu">mean</span>(dd<span class="sc">$</span>yp1)</span>
<span id="cb673-2"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb673-2" tabindex="-1"></a>EY0.g <span class="ot">&lt;-</span> <span class="fu">mean</span>(dd<span class="sc">$</span>yp0)</span>
<span id="cb673-3"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb673-3" tabindex="-1"></a><span class="fu">round</span>(<span class="fu">Contr</span>(EY1.g, EY0.g), <span class="dv">4</span>)</span></code></pre></div>
<pre><code>##                   RD     RR     OR 
## 0.8330 0.6508 0.1822 1.2800 2.6763</code></pre>
<p>The expectations <span class="math inline">\(E_Z[E(X=x, Z)]\)</span> taken over the joint distribution of
the confounders <span class="math inline">\(Z\)</span> are empirically estimated from the data by simply
computing the arithmetic means of the individually predicted values
<span class="math inline">\(\widetilde{Y_i}^{X_i=x}\)</span> of the outcome for the two exposure levels.</p>
<p>Compare the estimated contrasts with the true ones in item 3(b) above.
How big is the bias due to slight misspecification of the outcome model?
Compare in particular the estimate of the marginal OR here with the
conditional OR obtained in item (a) from the pertinent coefficient in
the logistic model. Which one is closer to 1?</p>
<ol start="4" style="list-style-type: decimal">
<li>Perform the same calculations using the tools in package <code>stdReg</code>
(see <a href="https://doi.org/10.1007/s10654-016-0157-3">Sjölander 2016</a>)</li>
</ol>
<div class="sourceCode" id="cb675"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb675-1"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb675-1" tabindex="-1"></a>mY.std <span class="ot">&lt;-</span> <span class="fu">stdGlm</span>(<span class="at">fit =</span> mY, <span class="at">data =</span> dd, <span class="at">X =</span> <span class="st">&quot;x&quot;</span>)</span>
<span id="cb675-2"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb675-2" tabindex="-1"></a><span class="fu">summary</span>(mY.std)</span></code></pre></div>
<pre><code>## 
## Formula: y ~ x + z1 + z2 + z3 + z4
## Family: binomial 
## Link function: logit 
## Exposure:  x 
## 
##   Estimate Std. Error lower 0.95 upper 0.95
## 0    0.651   0.000733      0.649      0.652
## 1    0.833   0.001562      0.830      0.836</code></pre>
<div class="sourceCode" id="cb677"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb677-1"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb677-1" tabindex="-1"></a><span class="fu">round</span>(<span class="fu">summary</span>(mY.std, <span class="at">contrast =</span> <span class="st">&quot;difference&quot;</span>, <span class="at">reference =</span> <span class="dv">0</span>)<span class="sc">$</span>est.table, <span class="dv">4</span>)</span></code></pre></div>
<pre><code>##   Estimate Std. Error lower 0.95 upper 0.95
## 0   0.0000     0.0000     0.0000     0.0000
## 1   0.1822     0.0017     0.1788     0.1856</code></pre>
<div class="sourceCode" id="cb679"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb679-1"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb679-1" tabindex="-1"></a><span class="fu">round</span>(<span class="fu">summary</span>(mY.std, <span class="at">contrast =</span> <span class="st">&quot;ratio&quot;</span>, <span class="at">reference =</span> <span class="dv">0</span>)<span class="sc">$</span>est.table, <span class="dv">4</span>)</span></code></pre></div>
<pre><code>##   Estimate Std. Error lower 0.95 upper 0.95
## 0     1.00     0.0000     1.0000     1.0000
## 1     1.28     0.0028     1.2745     1.2855</code></pre>
<div class="sourceCode" id="cb681"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb681-1"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb681-1" tabindex="-1"></a><span class="fu">round</span>(<span class="fu">summary</span>(mY.std,</span>
<span id="cb681-2"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb681-2" tabindex="-1"></a>  <span class="at">transform =</span> <span class="st">&quot;odds&quot;</span>,</span>
<span id="cb681-3"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb681-3" tabindex="-1"></a>  <span class="at">contrast =</span> <span class="st">&quot;ratio&quot;</span>, <span class="at">reference =</span> <span class="dv">0</span></span>
<span id="cb681-4"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb681-4" tabindex="-1"></a>)<span class="sc">$</span>est.table, <span class="dv">4</span>)</span></code></pre></div>
<pre><code>##   Estimate Std. Error lower 0.95 upper 0.95
## 0   1.0000     0.0000     1.0000     1.0000
## 1   2.6763     0.0315     2.6146     2.7379</code></pre>
<p>Check that you got the same point estimates as in the previous item.
Again, the confidence intervals are not very meaningful when analysing
the data covering the whole big target population. Of course, when
applied to real sample data they are relevant. In <code>stdReg</code> package, the
standard errors are obtained by the multivariate delta method built upon
M-estimation and robust sandwich estimator of the pertinent covariance
matrix, and approximate confidence intervals are derived from these in
the usual way.</p>
<ol start="5" style="list-style-type: decimal">
<li>If we are interested in the causal contrasts describing the effect
of exposure among those exposed (like ATT), the relevant factual and
counterfactual risks in that subset are</li>
</ol>
<p><span class="math display">\[
\begin{aligned}
\pi^1_1 &amp; = E(Y^{X=1}|X=1) = E(Y|X=1) = \pi_1, \\
\pi^0_1 &amp; = E(Y^{X=0}|X=1) = \sum_{X_i=1} E(Y|X=0, Z=z)P(Z=z|X=1)
\end{aligned}
\]</span></p>
<p>We are thus making and <em>observed vs. expected</em> comparison, in which the
<span class="math inline">\(z\)</span>-specific risks in the unexposed are weighted by the distribution of
<span class="math inline">\(Z\)</span> in the exposed subset of the target population. The risks and their
contrasts are estimated from the fit of the outcome model:</p>
<div class="sourceCode" id="cb683"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb683-1"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb683-1" tabindex="-1"></a>EY1att.g <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">subset</span>(dd, x <span class="sc">==</span> <span class="dv">1</span>)<span class="sc">$</span>yp1)</span>
<span id="cb683-2"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb683-2" tabindex="-1"></a>EY0att.g <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">subset</span>(dd, x <span class="sc">==</span> <span class="dv">1</span>)<span class="sc">$</span>yp0)</span>
<span id="cb683-3"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb683-3" tabindex="-1"></a><span class="fu">round</span>(<span class="fu">Contr</span>(EY1att.g, EY0att.g), <span class="dv">4</span>)</span></code></pre></div>
<pre><code>##                   RD     RR     OR 
## 0.8949 0.7560 0.1389 1.1837 2.7488</code></pre>
<p>Compare the results here with those for the whole target population.
What do you observe? Any guess about the causal effect of exposure among
the unexposed; is it bigger or smaller than among the exposed or among
the whole population?</p>
<ol style="list-style-type: decimal">
<li>Incidentally, the true causal contrasts among the exposed based on
the true model are similarly obtained from the quantities in item
3(b) above:</li>
</ol>
<div class="sourceCode" id="cb685"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb685-1"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb685-1" tabindex="-1"></a>EY1att <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">subset</span>(dd, x <span class="sc">==</span> <span class="dv">1</span>)<span class="sc">$</span>EY1.ind)</span>
<span id="cb685-2"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb685-2" tabindex="-1"></a>EY0att <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">subset</span>(dd, x <span class="sc">==</span> <span class="dv">1</span>)<span class="sc">$</span>EY0.ind)</span>
<span id="cb685-3"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb685-3" tabindex="-1"></a><span class="fu">round</span>(<span class="fu">Contr</span>(EY1att, EY0att), <span class="dv">4</span>)</span></code></pre></div>
<pre><code>##                   RD     RR     OR 
## 0.8955 0.7680 0.1275 1.1661 2.5896</code></pre>
<p>Compare the estimates in the previous item with the true values obtained
here.</p>
</div>
<div id="inverse-probability-weighting-ipw-by" class="section level2 hasAnchor" number="14.5">
<h2><span class="header-section-number">14.5</span> Inverse probability weighting (IPW) by<a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#inverse-probability-weighting-ipw-by" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<pre><code>propensity scores, and augmented IPW</code></pre>
<p>The next method is based on weighting each individual observation by the
inverse of the probability of belonging to that particular exposure
group, which was realized, this probability being predicted by
determinants of exposure.</p>
<ol style="list-style-type: decimal">
<li>Fit first a model for the exposure including main effects of the
<span class="math inline">\(Z\)</span>-variables only. <span class="math display">\[
p_i = E(X_i| Z_{1i} = z_{1i}, \dots, Z_{4i} = z_{4i})
= \text{expit}(\gamma_0 + \gamma_1 z_{1i} + \gamma_2 z_{2i} +
   \gamma_3 z_{i3} + \gamma_4 z_{4i} ), \quad i=1, \dots N
\]</span></li>
</ol>
<div class="sourceCode" id="cb688"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb688-1"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb688-1" tabindex="-1"></a>mX <span class="ot">&lt;-</span> <span class="fu">glm</span>(x <span class="sc">~</span> z1 <span class="sc">+</span> z2 <span class="sc">+</span> z3 <span class="sc">+</span> z4,</span>
<span id="cb688-2"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb688-2" tabindex="-1"></a>  <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> logit), <span class="at">data =</span> dd</span>
<span id="cb688-3"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb688-3" tabindex="-1"></a>)</span>
<span id="cb688-4"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb688-4" tabindex="-1"></a><span class="fu">round</span>(<span class="fu">ci.lin</span>(mX, <span class="at">Exp =</span> <span class="cn">TRUE</span>)[, <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">5</span>)], <span class="dv">4</span>)</span></code></pre></div>
<pre><code>##             Estimate exp(Est.)
## (Intercept)  -6.3031    0.0018
## z1           -0.0161    0.9840
## z2            1.6260    5.0833
## z3            0.2391    1.2702
## z4            0.8369    2.3093</code></pre>
<ol start="2" style="list-style-type: decimal">
<li>Extract the propensity scores, i.e. fitted probabilities of
belonging to exposure group 1: <span class="math display">\[ PS_i = \widehat{p_i} \]</span>, and
compare their distribution between the two groups.</li>
</ol>
<div class="sourceCode" id="cb690"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb690-1"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb690-1" tabindex="-1"></a>dd<span class="sc">$</span>PS <span class="ot">&lt;-</span> <span class="fu">predict</span>(mX, <span class="at">type =</span> <span class="st">&quot;response&quot;</span>)</span>
<span id="cb690-2"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb690-2" tabindex="-1"></a><span class="fu">summary</span>(dd<span class="sc">$</span>PS)</span></code></pre></div>
<pre><code>##     Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
## 0.005256 0.041532 0.112765 0.172440 0.248554 0.613993</code></pre>
<div class="sourceCode" id="cb692"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb692-1"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb692-1" tabindex="-1"></a><span class="fu">with</span>(<span class="fu">subset</span>(dd, x <span class="sc">==</span> <span class="dv">0</span>), <span class="fu">plot</span>(<span class="fu">density</span>(PS), <span class="at">lty =</span> <span class="dv">2</span>))</span>
<span id="cb692-2"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb692-2" tabindex="-1"></a><span class="fu">with</span>(<span class="fu">subset</span>(dd, x <span class="sc">==</span> <span class="dv">1</span>), <span class="fu">lines</span>(<span class="fu">density</span>(PS), <span class="at">lty =</span> <span class="dv">1</span>))</span></code></pre></div>
<p><img src="causInf2-s_files/figure-html/propScore-1.png" width="672" /></p>
<p>How different are the distributions? Are they sufficiently overlapping?</p>
<ol start="3" style="list-style-type: decimal">
<li>Compute the weights <span class="math inline">\(W_i = 1/\text{PS}_i\)</span>, when <span class="math inline">\(X_i=1\)</span>, and
<span class="math inline">\(W_i = 1/(1-\text{PS}_i)\)</span>, when <span class="math inline">\(X_i=0\)</span>. Look at the sum as well as
the distribution summary of the weights in the exposure groups. The
sum of weights should be close to <span class="math inline">\(n\)</span> in both groups.</li>
</ol>
<div class="sourceCode" id="cb693"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb693-1"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb693-1" tabindex="-1"></a>dd<span class="sc">$</span>w <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(dd<span class="sc">$</span>x <span class="sc">==</span> <span class="dv">1</span>, <span class="dv">1</span> <span class="sc">/</span> dd<span class="sc">$</span>PS, <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> dd<span class="sc">$</span>PS))</span>
<span id="cb693-2"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb693-2" tabindex="-1"></a><span class="fu">with</span>(dd, <span class="fu">tapply</span>(w, x, sum))</span></code></pre></div>
<pre><code>##        0        1 
## 498880.5 565237.5</code></pre>
<ol start="4" style="list-style-type: decimal">
<li>Compute now the weighted estimates of the counterfactual risks for
both exposure categories <span class="math display">\[ \widehat{E}_w(Y^{X = x}) =
\frac{ \sum_{i=1}^n {\mathbf 1}_{ \{X_i=x\} } W_i Y_i }
   {\sum_{i=1}^n {\mathbf 1}_{ \{X_i=x\} }W_i} =
\frac{ \sum_{X_i = x} W_i Y_i }{\sum_{X_i=x} W_i}, \quad x = 0,1, \]</span>
and their causal contrasts, for instance
<span class="math display">\[ \widehat{\text{RD}}_{w} = \widehat{E}_w(Y^{X = 1}) -
              \widehat{E}_w(Y^{X = 0})
=   \frac{ \sum_{i=1}^n X_i W_i Y_i }{\sum_{i=1}^n X_i W_i} -
    \frac{ \sum_{i=1}^n (1-X_i) W_i Y_i }{\sum_{i=1}^n (1-X_i) W_i}
\]</span></li>
</ol>
<div class="sourceCode" id="cb695"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb695-1"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb695-1" tabindex="-1"></a>EY1.w <span class="ot">&lt;-</span> <span class="fu">sum</span>(dd<span class="sc">$</span>x <span class="sc">*</span> dd<span class="sc">$</span>w <span class="sc">*</span> dd<span class="sc">$</span>y) <span class="sc">/</span> <span class="fu">sum</span>(dd<span class="sc">$</span>x <span class="sc">*</span> dd<span class="sc">$</span>w)</span>
<span id="cb695-2"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb695-2" tabindex="-1"></a>EY0.w <span class="ot">&lt;-</span> <span class="fu">sum</span>((<span class="dv">1</span> <span class="sc">-</span> dd<span class="sc">$</span>x) <span class="sc">*</span> dd<span class="sc">$</span>w <span class="sc">*</span> dd<span class="sc">$</span>y) <span class="sc">/</span> <span class="fu">sum</span>((<span class="dv">1</span> <span class="sc">-</span> dd<span class="sc">$</span>x) <span class="sc">*</span> dd<span class="sc">$</span>w)</span>
<span id="cb695-3"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb695-3" tabindex="-1"></a><span class="fu">round</span>(<span class="fu">Contr</span>(EY1.w, EY0.w), <span class="dv">4</span>)</span></code></pre></div>
<pre><code>##                   RD     RR     OR 
## 0.8037 0.6519 0.1518 1.2329 2.1868</code></pre>
<p>These estimates seem to be somewhat downward biased when comparing to
true values. Could this be because of omitting the relatively strong
product term effect of <span class="math inline">\(Z_2\)</span> and <span class="math inline">\(Z_4\)</span>?</p>
<p>5.Let us attempt to correct the estimates by a double robust approach
called augmented IPW estimation (AIPW), which combines the g-formula and
the IPW approach. The AIPW-estimator can be expressed in two ways:
either an IPW-corrected g-formula estimator, or a g-corrected
IPW-estimator.</p>
<p><span class="math display">\[
\begin{aligned}
\widehat{E}_a(Y^{X=x}) &amp; = \widehat{E}_g(Y^{X=x}) +
   \frac{1}{n} \sum_{i=1}^n \frac{ {\mathbf 1}_{\{X_i=x\}} W_i ( Y_i - \widetilde{Y}_i^{X_i=x} ) }
   {\sum_{i=1}^n {\mathbf 1}_{\{X_i=x\}} W_i} \\
       &amp; =   \widehat{E}_w(Y^{X=x}) -
    \frac{1}{n} \sum_{i=1}^n \left[ \frac{ {\mathbf 1}_{\{X_i=x\}} W_i }
            {\sum_{i=1}^n {\mathbf 1}_{\{X_i=x\}} W_i } - 1 \right] \widetilde{Y}_i^{X_i=x}.
\end{aligned}
\]</span></p>
<div class="sourceCode" id="cb697"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb697-1"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb697-1" tabindex="-1"></a>EY1.a <span class="ot">&lt;-</span> EY1.g <span class="sc">+</span> <span class="fu">mean</span>(dd<span class="sc">$</span>x <span class="sc">*</span> (dd<span class="sc">$</span>y <span class="sc">-</span> dd<span class="sc">$</span>yp1) <span class="sc">*</span> dd<span class="sc">$</span>w <span class="sc">/</span> <span class="fu">sum</span>(dd<span class="sc">$</span>x <span class="sc">*</span> dd<span class="sc">$</span>w))</span>
<span id="cb697-2"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb697-2" tabindex="-1"></a><span class="do">##  or   EY1.w - mean( ( ( dd$x*dd$w /sum(dd$x*dd$w) ) - 1 )*dd$yp1 )</span></span>
<span id="cb697-3"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb697-3" tabindex="-1"></a>EY0.a <span class="ot">&lt;-</span> EY0.g <span class="sc">+</span> <span class="fu">mean</span>((<span class="dv">1</span> <span class="sc">-</span> dd<span class="sc">$</span>x) <span class="sc">*</span> (dd<span class="sc">$</span>y <span class="sc">-</span> dd<span class="sc">$</span>yp0) <span class="sc">*</span> dd<span class="sc">$</span>w <span class="sc">/</span> <span class="fu">sum</span>((<span class="dv">1</span> <span class="sc">-</span> dd<span class="sc">$</span>x) <span class="sc">*</span> dd<span class="sc">$</span>w))</span>
<span id="cb697-4"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb697-4" tabindex="-1"></a><span class="do">##  or   EY0.w - mean( ( ( (1-dd$x)*dd$w/sum((1-dd$x)*dd$w) ) - 1 )*dd$yp0 )</span></span>
<span id="cb697-5"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb697-5" tabindex="-1"></a><span class="fu">round</span>(<span class="fu">Contr</span>(EY1.a, EY0.a), <span class="dv">4</span>)</span></code></pre></div>
<pre><code>##                   RD     RR     OR 
## 0.8330 0.6508 0.1822 1.2800 2.6763</code></pre>
<p>Compare these results with those obtained by g-formula and by
non-augmented IPW method. Was augmentation successful?</p>
</div>
<div id="improving-ipw-estimation-and-using-r-package-psweight" class="section level2 hasAnchor" number="14.6">
<h2><span class="header-section-number">14.6</span> Improving IPW estimation and using R package <code>PSweight</code><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#improving-ipw-estimation-and-using-r-package-psweight" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We now try to improve IPW-estimation by a richer exposure model. In
computations we shall utilize the R package <code>PSweight</code> (see <a href="https://cran.r-project.org/web/packages/PSweight/vignettes/vignette.pdf">PSweight
vignette</a>).</p>
<ol style="list-style-type: decimal">
<li>First, we compute the weights from a more flexible exposure model
which contains all pairwise product terms of the parents of <span class="math inline">\(X\)</span>.
According to the causal diagram, <span class="math inline">\(Z_1\)</span> is not in that subset, so it
is left out. The exposure model is specified and the weights are
obtained as follows.</li>
</ol>
<div class="sourceCode" id="cb699"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb699-1"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb699-1" tabindex="-1"></a>mX2 <span class="ot">&lt;-</span> <span class="fu">glm</span>(x <span class="sc">~</span> (z2 <span class="sc">+</span> z3 <span class="sc">+</span> z4)<span class="sc">^</span><span class="dv">2</span>, <span class="at">family =</span> binomial, <span class="at">data =</span> dd)</span>
<span id="cb699-2"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb699-2" tabindex="-1"></a><span class="fu">round</span>(<span class="fu">ci.lin</span>(mX2, <span class="at">Exp =</span> <span class="cn">TRUE</span>)[, <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">5</span>)], <span class="dv">3</span>)</span></code></pre></div>
<pre><code>##             Estimate exp(Est.)
## (Intercept)   -5.085     0.006
## z2             0.143     1.154
## z3             0.243     1.275
## z4             0.527     1.693
## z2:z3         -0.003     0.997
## z2:z4          0.376     1.456
## z3:z4          0.001     1.001</code></pre>
<div class="sourceCode" id="cb701"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb701-1"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb701-1" tabindex="-1"></a>psw <span class="ot">&lt;-</span> <span class="fu">SumStat</span>(</span>
<span id="cb701-2"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb701-2" tabindex="-1"></a>  <span class="at">ps.formula =</span> mX2<span class="sc">$</span>formula, <span class="at">data =</span> dd,</span>
<span id="cb701-3"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb701-3" tabindex="-1"></a>  <span class="at">weight =</span> <span class="fu">c</span>(<span class="st">&quot;IPW&quot;</span>, <span class="st">&quot;treated&quot;</span>, <span class="st">&quot;overlap&quot;</span>)</span>
<span id="cb701-4"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb701-4" tabindex="-1"></a>)</span>
<span id="cb701-5"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb701-5" tabindex="-1"></a>dd<span class="sc">$</span>PS2 <span class="ot">&lt;-</span> psw<span class="sc">$</span>propensity[, <span class="dv">2</span>] <span class="co"># propensity scores extracted</span></span>
<span id="cb701-6"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb701-6" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">density</span>(dd<span class="sc">$</span>PS2[dd<span class="sc">$</span>x <span class="sc">==</span> <span class="dv">0</span>]), <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb701-7"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb701-7" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">density</span>(dd<span class="sc">$</span>PS2[dd<span class="sc">$</span>x <span class="sc">==</span> <span class="dv">1</span>]), <span class="at">lty =</span> <span class="dv">1</span>)</span></code></pre></div>
<p><img src="causInf2-s_files/figure-html/PSweight-1.png" width="672" /></p>
<p>Note that apart from ordinary IPW, other types of weights can also also
obtained. These are relevant when estimating other kinds of causal
contrasts, like <em>average treatment effect among the treated</em> (ATT) and
``average treatment effect in the overlap (or equipoise) population’’
(ATO).</p>
<ol start="2" style="list-style-type: decimal">
<li><code>PSweight</code> includes some useful tools to examine the properties of
the distribution and to check the balance of the propensity scores,
for instance</li>
</ol>
<div class="sourceCode" id="cb702"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb702-1"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb702-1" tabindex="-1"></a><span class="fu">plot</span>(psw, <span class="at">type =</span> <span class="st">&quot;balance&quot;</span>, <span class="at">metric =</span> <span class="st">&quot;PSD&quot;</span>)</span></code></pre></div>
<p><img src="causInf2-s_files/figure-html/check%20balance-1.png" width="672" /></p>
<p>It is desirable that the horisontal values of these measures for given
weights are less than 0.1.</p>
<ol start="3" style="list-style-type: decimal">
<li>Estimation and reporting of the causal contrasts. For relative
contrasts, the summary method provides the results on the log-scale.</li>
</ol>
<div class="sourceCode" id="cb703"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb703-1"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb703-1" tabindex="-1"></a>ipwest <span class="ot">&lt;-</span> <span class="fu">PSweight</span>(<span class="at">ps.formula =</span> mX2, <span class="at">yname =</span> <span class="st">&quot;y&quot;</span>, <span class="at">data =</span> dd, <span class="at">weight =</span> <span class="st">&quot;IPW&quot;</span>)</span>
<span id="cb703-2"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb703-2" tabindex="-1"></a>ipwest</span></code></pre></div>
<pre><code>## Original group value:  0, 1 
## 
## Point estimate: 
## 0.6526, 0.8255</code></pre>
<div class="sourceCode" id="cb705"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb705-1"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb705-1" tabindex="-1"></a><span class="fu">summary</span>(ipwest)</span></code></pre></div>
<pre><code>## 
## Closed-form inference: 
## 
## Original group value:  0, 1 
## 
## Contrast: 
##             0 1
## Contrast 1 -1 1
## 
##             Estimate Std.Error       lwr     upr  Pr(&gt;|z|)    
## Contrast 1 0.1729179 0.0025636 0.1678934 0.17794 &lt; 2.2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<div class="sourceCode" id="cb707"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb707-1"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb707-1" tabindex="-1"></a>(logRR.ipw <span class="ot">&lt;-</span> <span class="fu">summary</span>(ipwest, <span class="at">type =</span> <span class="st">&quot;RR&quot;</span>))</span></code></pre></div>
<pre><code>## 
## Closed-form inference: 
## 
## Inference in log scale: 
## Original group value:  0, 1 
## 
## Contrast: 
##             0 1
## Contrast 1 -1 1
## 
##             Estimate Std.Error       lwr     upr  Pr(&gt;|z|)    
## Contrast 1 0.2350512 0.0031789 0.2288207 0.24128 &lt; 2.2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<div class="sourceCode" id="cb709"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb709-1"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb709-1" tabindex="-1"></a><span class="fu">round</span>(<span class="fu">exp</span>(logRR.ipw<span class="sc">$</span>estimates[<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">5</span>)]), <span class="dv">3</span>)</span></code></pre></div>
<pre><code>## [1] 1.265 1.257 1.273</code></pre>
<div class="sourceCode" id="cb711"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb711-1"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb711-1" tabindex="-1"></a><span class="fu">round</span>(<span class="fu">exp</span>(<span class="fu">summary</span>(ipwest, <span class="at">type =</span> <span class="st">&quot;OR&quot;</span>)<span class="sc">$</span>estimates[<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">5</span>)]), <span class="dv">3</span>)</span></code></pre></div>
<pre><code>## [1] 2.519 2.434 2.606</code></pre>
<p>Compare these with the previous IPW estimate and the AIPW estimate as
well as the true values. Have we obtained nearly unbiased results?</p>
<p>The standard errors provided by <code>PSweight</code> are by default based on the
empirical sandwich covariance matrix and application of delta method as
appropriate. Bootstrapping is also possible but is computationally very
intensive and is recommended to be used only in relatively small
samples.</p>
<ol start="4" style="list-style-type: decimal">
<li>If we are interested in the effect of exposure among the exposed
(like ATT) then the weights are <span class="math inline">\(W_i = 1\)</span> for the exposed and
<span class="math inline">\(W_i = \text{PS}_i/(1-\text{PS}_i)\)</span> for the unexposed. Call again
<code>PSweight</code> but with another choice of weight:</li>
</ol>
<div class="sourceCode" id="cb713"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb713-1"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb713-1" tabindex="-1"></a>psatt <span class="ot">&lt;-</span> <span class="fu">PSweight</span>(<span class="at">ps.formula =</span> mX2, <span class="at">yname =</span> <span class="st">&quot;y&quot;</span>, <span class="at">data =</span> dd, <span class="at">weight =</span> <span class="st">&quot;treated&quot;</span>)</span>
<span id="cb713-2"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb713-2" tabindex="-1"></a>psatt</span></code></pre></div>
<pre><code>## Original group value:  0, 1 
## Treatment group value:  1 
## 
## Point estimate: 
## 0.7667, 0.8949</code></pre>
<div class="sourceCode" id="cb715"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb715-1"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb715-1" tabindex="-1"></a><span class="fu">round</span>(<span class="fu">summary</span>(psatt)<span class="sc">$</span>estimates[<span class="dv">1</span>], <span class="dv">4</span>)</span></code></pre></div>
<pre><code>## [1] 0.1282</code></pre>
<div class="sourceCode" id="cb717"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb717-1"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb717-1" tabindex="-1"></a><span class="fu">round</span>(<span class="fu">exp</span>(<span class="fu">summary</span>(psatt, <span class="at">type =</span> <span class="st">&quot;RR&quot;</span>)<span class="sc">$</span>estimates[<span class="dv">1</span>]), <span class="dv">3</span>)</span></code></pre></div>
<pre><code>## [1] 1.167</code></pre>
<div class="sourceCode" id="cb719"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb719-1"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb719-1" tabindex="-1"></a><span class="fu">round</span>(<span class="fu">exp</span>(<span class="fu">summary</span>(psatt, <span class="at">type =</span> <span class="st">&quot;OR&quot;</span>)<span class="sc">$</span>estimates[<span class="dv">1</span>]), <span class="dv">3</span>)</span></code></pre></div>
<pre><code>## [1] 2.592</code></pre>
<p>Compare the results here with those obtained by g-formula in item 4(e)
and with the true contrasts in item 4(f) above.</p>
</div>
<div id="targeted-maximum-likelihood-estimation-tmle" class="section level2 hasAnchor" number="14.7">
<h2><span class="header-section-number">14.7</span> Targeted maximum likelihood estimation (TMLE)<a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#targeted-maximum-likelihood-estimation-tmle" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>We now consider now another double robust approach, known as targeted
maximum likelihood estimation (TMLE). It also corrects the estimator
obtained from the outcome model by elements that are derived from the
exposure model. See <a href="https://doi.org/10.1093/aje/kww165">Schuler and Rose
(2017)</a> for more details</p>
<ol style="list-style-type: decimal">
<li>The first step is to utilize the propensity scores obtained above
and define the so called clever covariates</li>
</ol>
<div class="sourceCode" id="cb721"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb721-1"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb721-1" tabindex="-1"></a>dd<span class="sc">$</span>H1 <span class="ot">&lt;-</span> dd<span class="sc">$</span>x <span class="sc">/</span> dd<span class="sc">$</span>PS2</span>
<span id="cb721-2"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb721-2" tabindex="-1"></a>dd<span class="sc">$</span>H0 <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> dd<span class="sc">$</span>x) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> dd<span class="sc">$</span>PS2)</span></code></pre></div>
<ol start="2" style="list-style-type: decimal">
<li>Then, a working model is fitted for the outcome, in which the clever
covariates are explanatory variables, but the model also includes
the previously fitted linear predictor
<span class="math inline">\(\widehat{\eta}_i = \text{logit}(\widehat Y_i)\)</span> from the original
outcome model <code>mY</code> as an offset term. Moreover, the intercept is
removed.</li>
</ol>
<div class="sourceCode" id="cb722"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb722-1"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb722-1" tabindex="-1"></a>epsmod <span class="ot">&lt;-</span> <span class="fu">glm</span>(y <span class="sc">~</span> <span class="sc">-</span><span class="dv">1</span> <span class="sc">+</span> H0 <span class="sc">+</span> H1 <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">qlogis</span>(yh)),</span>
<span id="cb722-2"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb722-2" tabindex="-1"></a>  <span class="at">family =</span> <span class="fu">binomial</span>(<span class="at">link =</span> logit), <span class="at">data =</span> dd</span>
<span id="cb722-3"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb722-3" tabindex="-1"></a>)</span>
<span id="cb722-4"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb722-4" tabindex="-1"></a>eps <span class="ot">&lt;-</span> <span class="fu">coef</span>(epsmod)</span>
<span id="cb722-5"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb722-5" tabindex="-1"></a>eps</span></code></pre></div>
<pre><code>##           H0           H1 
##  0.007197951 -0.002859654</code></pre>
<ol start="3" style="list-style-type: decimal">
<li>The logit-transformed predicted values <span class="math inline">\(\widetilde{Y}_i^{X_i=1}\)</span> and
<span class="math inline">\(\widetilde{Y}_i^{X_i=0}\)</span> of counterfactual individual risks from
the original outcome model are now corrected by the estimated
coefficients of the clever covariates, and the corrected predictions
are returned to the original scale.</li>
</ol>
<div class="sourceCode" id="cb724"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb724-1"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb724-1" tabindex="-1"></a>yp0.H <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="fu">qlogis</span>(dd<span class="sc">$</span>yp0) <span class="sc">+</span> eps[<span class="dv">1</span>] <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> dd<span class="sc">$</span>PS2))</span>
<span id="cb724-2"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb724-2" tabindex="-1"></a>yp1.H <span class="ot">&lt;-</span> <span class="fu">plogis</span>(<span class="fu">qlogis</span>(dd<span class="sc">$</span>yp1) <span class="sc">+</span> eps[<span class="dv">2</span>] <span class="sc">/</span> dd<span class="sc">$</span>PS2)</span></code></pre></div>
<ul>
<li></li>
</ul>
<p>Estimates of the causal contrasts:</p>
<div class="sourceCode" id="cb725"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb725-1"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb725-1" tabindex="-1"></a>EY0.t <span class="ot">&lt;-</span> <span class="fu">mean</span>(yp0.H)</span>
<span id="cb725-2"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb725-2" tabindex="-1"></a>EY1.t <span class="ot">&lt;-</span> <span class="fu">mean</span>(yp1.H)</span>
<span id="cb725-3"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb725-3" tabindex="-1"></a><span class="fu">round</span>(<span class="fu">Contr</span>(EY1.t, EY0.t), <span class="dv">4</span>)</span></code></pre></div>
<pre><code>##                   RD     RR     OR 
## 0.8246 0.6526 0.1720 1.2635 2.5020</code></pre>
<p>Compare these with previous results and with the true values.</p>
</div>
<div id="tmle-with-superlearner" class="section level2 hasAnchor" number="14.8">
<h2><span class="header-section-number">14.8</span> TMLE with SuperLearner<a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#tmle-with-superlearner" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Let us finally apply some fashionable tools of statistical learning, aka
<em>machine learning</em>, using the package <code>SuperLearner</code> to fit flexible
models for both exposure and outcome. As this method is computationally
much more demanding, we illustrate its use by a sample of 2000 subjects
only.</p>
<ol style="list-style-type: decimal">
<li>A simple random sample of <span class="math inline">\(n=2000\)</span> is drawn from the population.</li>
</ol>
<div class="sourceCode" id="cb727"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb727-1"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb727-1" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">7622</span>)</span>
<span id="cb727-2"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb727-2" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">2000</span></span>
<span id="cb727-3"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb727-3" tabindex="-1"></a>sampind <span class="ot">&lt;-</span> <span class="fu">sample</span>(N, n)</span>
<span id="cb727-4"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb727-4" tabindex="-1"></a>samp <span class="ot">&lt;-</span> dd[sampind, ]</span></code></pre></div>
<ol start="2" style="list-style-type: decimal">
<li>The algorithms to be used in this exercise are chosen</li>
</ol>
<div class="sourceCode" id="cb728"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb728-1"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb728-1" tabindex="-1"></a>SL.library <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb728-2"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb728-2" tabindex="-1"></a>  <span class="st">&quot;SL.glm&quot;</span>, <span class="st">&quot;SL.step&quot;</span>, <span class="st">&quot;SL.step.interaction&quot;</span>,</span>
<span id="cb728-3"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb728-3" tabindex="-1"></a>  <span class="st">&quot;SL.glm.interaction&quot;</span>, <span class="st">&quot;SL.gam&quot;</span>,</span>
<span id="cb728-4"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb728-4" tabindex="-1"></a>  <span class="st">&quot;SL.randomForest&quot;</span>, <span class="st">&quot;SL.rpart&quot;</span></span>
<span id="cb728-5"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb728-5" tabindex="-1"></a>)</span></code></pre></div>
<ol start="3" style="list-style-type: decimal">
<li>Function <code>tmle()</code> computes estimates of the causal contrasts of
interest. Argument <code>A</code> is for the exposure variable, and argument
<code>W</code> contains the confounders.</li>
</ol>
<p>The run can take a while …</p>
<div class="sourceCode" id="cb729"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb729-1"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb729-1" tabindex="-1"></a>tmlest <span class="ot">&lt;-</span> <span class="fu">tmle</span>(</span>
<span id="cb729-2"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb729-2" tabindex="-1"></a>  <span class="at">Y =</span> samp<span class="sc">$</span>y, <span class="at">A =</span> samp<span class="sc">$</span>x, <span class="at">W =</span> samp[, <span class="fu">c</span>(<span class="st">&quot;z1&quot;</span>, <span class="st">&quot;z2&quot;</span>, <span class="st">&quot;z3&quot;</span>, <span class="st">&quot;z4&quot;</span>)],</span>
<span id="cb729-3"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb729-3" tabindex="-1"></a>  <span class="at">family =</span> <span class="st">&quot;binomial&quot;</span>, <span class="at">Q.SL.library =</span> SL.library,</span>
<span id="cb729-4"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb729-4" tabindex="-1"></a>  <span class="at">g.SL.library =</span> SL.library</span>
<span id="cb729-5"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb729-5" tabindex="-1"></a>)</span>
<span id="cb729-6"><a href="causal-inference-2-model-based-estimation-of-causal-estimands.html#cb729-6" tabindex="-1"></a><span class="fu">summary</span>(tmlest)</span></code></pre></div>
<p>Let us take a closer look at the results. In the beginning are reported
the fractions by which the separate algorithms contribute to the
combined algorithm. After that are given estimates of the causal
contrasts together with their estimated variances and 95% confidence
intervals. The variance of each contrast (on log-scale for RR and OR) is
estimated as the variance of the empirical influence curve divided by
<span class="math inline">\(n\)</span>, the number of i.i.d. units of observation. Furthermore, causal risk
differences are estimated also for those factually exposed and
unexposed, respectively.</p>
<p>Note that because this analysis was based on sample data, the estimates
are most probably deviating from the true values because of pure random
error. Therefore it is not possible to assess the magnitude of a
possible bias from a single sample.</p>
<p><strong>Homework.</strong> When you have more time, try to run <code>tmle</code> on as large
sample as is possible and compare its results with previous ones
computed for the whole target population.</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="nested-case-control-study-and-case-cohort-study-risk-factors-of-coronary-heart-disease.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="time-dependent-variables-and-multiple-states.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/SPE-R/SPE/edit/master/pracs-book/causInf2-s.rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["SPE-R-2024-practicals-with-solutions.pdf", "SPE-R-2024-practicals-with-solutions.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
